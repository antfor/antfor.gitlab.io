<!DOCTYPE html>
<html>
<head>
  <title>Tropism Correction Visualization</title>
  <script src="https://twgljs.org/dist/4.x/twgl-full.min.js"></script>
  <style>
    canvas { width: 100%; height: 100%; display: block; }
    body { margin: 0; overflow: hidden; }
  </style>
</head>
<body>
<canvas id="c"></canvas>
<script>
const gl = document.querySelector("#c").getContext("webgl");
const programInfo = twgl.createProgramInfo(gl, [
  `
  attribute vec4 position;
  uniform mat4 u_matrix;
  void main() {
    gl_Position = u_matrix * position;
  }
  `,
  `
  precision mediump float;
  uniform vec4 u_color;
  void main() {
    gl_FragColor = u_color;
  }
  `
]);

const arrays = {
  position: { numComponents: 2, data: [0, 0, 1, 0] } // Line from origin to H
};
const bufferInfo = twgl.createBufferInfoFromArrays(gl, arrays);

function applyTropismCorrection(H, T, e) {
  const hNorm = twgl.v3.normalize(H);
  const tNorm = twgl.v3.normalize(T);
  const cross = twgl.v3.cross(hNorm, tNorm);
  const alpha = e * twgl.v3.length(cross);
  const correction = twgl.v3.scale(tNorm, alpha);
  const H_prime = twgl.v3.add(hNorm, correction);
  return twgl.v3.normalize(H_prime);
}

function drawVector(vec, color) {
  const scaled = twgl.v3.scale(vec, 0.8);
  const arrays = {
    position: { numComponents: 2, data: [0, 0, scaled[0], scaled[1]] }
  };
  const bufferInfo = twgl.createBufferInfoFromArrays(gl, arrays);
  gl.useProgram(programInfo.program);
  twgl.setBuffersAndAttributes(gl, programInfo, bufferInfo);
  twgl.setUniforms(programInfo, {
    u_matrix: twgl.m4.ortho(-1, 1, -1, 1, -1, 1),
    u_color: color
  });
  twgl.drawBufferInfo(gl, bufferInfo, gl.LINES);
}

function render(time) {
  time *= 0.001;
  twgl.resizeCanvasToDisplaySize(gl.canvas);
  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
  gl.clear(gl.COLOR_BUFFER_BIT);

  const H = [Math.cos(time), Math.sin(time), 0];
  const T = [0, -1, 0];
  const e = 0.5;

  const H_prime = applyTropismCorrection(H, T, e);

  drawVector(H, [0, 1, 0, 1]);       // Green: original H
  drawVector(T, [0, 0, 1, 1]);       // Blue: tropism T
  drawVector(H_prime, [1, 0, 0, 1]); // Red: corrected H'

  requestAnimationFrame(render);
}
requestAnimationFrame(render);
</script>
</body>
</html>

